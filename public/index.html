<!DOCTYPE html>
<html>

<head>
    <title>Halo Team Scrambler</title>
    <link rel="icon" href="favicon.ico" type="image/png">
    <link rel="stylesheet" href="style.css" type="text/css">
    <script charset="utf8" src="elm.js" type="text/javascript"></script>
</head>

<body>

<dialog id="alert-dialog">
    <p></p>
    <button autofocus commandfor="alert-dialog" command="close">Ok</button>
</dialog>

<main id="app"></main>

<script type="text/javascript">
const alertDialog = document.getElementById("alert-dialog")
const alertDialogTextContainer = alertDialog.querySelector("p")

function showAlertDialog(msg) {
    alertDialogTextContainer.textContent = msg
    alertDialog.showModal()
}

function reconstructSavedLocalStorage(items) {
    const r = {}
    for (const item in items) {
        try {
            const savedJson = localStorage.getItem(item)
            r[item] = savedJson ? items[item].deserialize(savedJson) : items[item].default
        } catch (e) {
            if (!(e instanceof SyntaxError)) {
                throw e
            }

            localStorage.removeItem(item)
            r[item] = items[item].default
        }
    }

    return r
}

const savedPlayersKey = "savedPlayers"

const app = Elm.Main.init({
    node: document.getElementById("app"),
    flags: reconstructSavedLocalStorage({
        [savedPlayersKey]: {
            default: [],
            deserialize: JSON.parse
        }
    })
})

app.ports.alert.subscribe(showAlertDialog)

app.ports.savePlayers.subscribe(players => {
    localStorage.setItem(savedPlayersKey, JSON.stringify(players))
})

app.ports.clearLocalStorage.subscribe(() => {
    localStorage.clear()
})
</script>

</body>

</html>